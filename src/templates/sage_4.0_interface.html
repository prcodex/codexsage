<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE - Premium Financial Intelligence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #f8f9fa;
            color: #202124;
        }
        .header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #E1E8ED;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; color: #202124; }
        .feed {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }
        .email-item {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .sender {
            color: #1DA1F2;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .timestamp {
            color: #657786;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .email-title {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .keywords, .actors, .themes {
            font-size: 14px;
            color: #657786;
            margin-bottom: 8px;
        }
        .summary {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #1DA1F2;
            font-size: 15px;
            line-height: 1.6;
            color: #202124;
            white-space: pre-wrap;
        }
        .summary a {
            color: #1DA1F2 !important;
            text-decoration: none;
            cursor: pointer;
        }
        .summary a:hover { text-decoration: underline; }
        .ai-score {
            margin-top: 12px;
            font-size: 14px;
            color: #657786;
        }
        
        /* Gmail-style Detail Panel */
        .detail-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 60%;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .detail-panel.open {
            right: 0;
        }
        .detail-header {
            padding: 20px;
            border-bottom: 1px solid #E1E8ED;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-close {
            font-size: 24px;
            cursor: pointer;
            color: #657786;
            border: none;
            background: none;
        }
        .detail-close:hover { color: #202124; }
        .detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .email-subject {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .email-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #E1E8ED;
        }
        .sender-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1DA1F2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .sender-details {
            flex: 1;
        }
        .sender-name {
            font-weight: 600;
            color: #202124;
        }
        .email-date {
            color: #657786;
            font-size: 13px;
            margin-left: 10px;
        }
        .email-iframe {
            width: 100%;
            min-height: 500px;
            border: none;
            background: white;
        }
        
        /* Overlay for panel */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }
        .overlay.open {
            display: block;
        }
    
        /* Show More Button */
        .show-more-btn {
            background: #1DA1F2;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 0;
            transition: background 0.2s;
        }
        
        .show-more-btn:hover {
            background: #1a8cd8;
        }
        
        .card-details {
            display: none;
        }
        
        .card-details.visible {
            display: block;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“° SAGE - Premium Financial Intelligence</h1>
    </div>
    
    <div class="feed" id="feed"></div>
    
    <!-- Overlay -->
    <div id="overlay" class="overlay" onclick="closeEmailDetail()"></div>
    
    <!-- Gmail-style Detail Panel -->
    <div id="detailPanel" class="detail-panel">
        <div class="detail-header">
            <h2>Email</h2>
            <button class="detail-close" onclick="closeEmailDetail()">&times;</button>
        </div>
        <div class="detail-body" id="detailContent">
            Loading...
        </div>
    </div>

    <script>

        function toggleDetails(cardId) {
            const details = document.getElementById('details-' + cardId);
            const btn = document.getElementById('btn-' + cardId);
            
            if (details.classList.contains('visible')) {
                details.classList.remove('visible');
                btn.textContent = 'Show More â–¼';
            } else {
                details.classList.add('visible');
                btn.textContent = 'Show Less â–²';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function openEmailDetail(emailId) {
            const panel = document.getElementById('detailPanel');
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('detailContent');
            
            content.innerHTML = '<div style="padding: 20px;">Loading email...</div>';
            panel.classList.add('open');
            overlay.classList.add('open');
            
            try {
                const response = await fetch('/api/email/' + emailId);
                const email = await response.json();
                
                if (email.error) {
                    content.innerHTML = '<div style="padding: 20px; color: red;">Error: ' + email.error + '</div>';
                    return;
                }
                
                // Create Gmail-style display
                let html = '<div class="email-subject">' + escapeHtml(email.title || email.subject || 'No subject') + '</div>';
                
                html += '<div class="email-meta">';
                html += '<div class="sender-avatar">' + ((email.author || 'U')[0].toUpperCase()) + '</div>';
                html += '<div class="sender-details">';
                html += '<div class="sender-name">' + escapeHtml(email.author || 'Unknown') + '</div>';
                html += '<div class="email-date" style="color: #657786; font-size: 13px;">' + formatTimestamp(email.created_at) + '</div>';
                html += '</div></div>';
                
                // Render email content in iframe
                html += '<div style="margin-top: 20px;">';
                
                if (email.content_html && email.content_html.length > 100) {
                    html += '<iframe id="emailIframe" class="email-iframe" style="width: 100%; min-height: 600px; border: 1px solid #E1E8ED; border-radius: 4px;"></iframe>';
                } else if (email.content_text) {
                    html += '<div style="white-space: pre-wrap; padding: 20px; background: #f8f9fa; border-radius: 4px;">' + escapeHtml(email.content_text) + '</div>';
                } else {
                    html += '<div style="padding: 20px; color: #657786;">No content available</div>';
                }
                
                html += '</div>';
                
                content.innerHTML = html;
                
                // Write HTML to iframe if available
                if (email.content_html && email.content_html.length > 100) {
                    const iframe = document.getElementById('emailIframe');
                    if (iframe) {
                        const iframeDoc = iframe.contentWindow.document;
                        iframeDoc.open();
                        iframeDoc.write(email.content_html);
                        iframeDoc.close();
                        
                        // Adjust iframe height to content
                        iframe.onload = function() {
                            try {
                                const height = iframeDoc.body.scrollHeight;
                                iframe.style.height = (height + 50) + 'px';
                            } catch(e) {
                                iframe.style.height = '600px';
                            }
                        };
                    }
                }
                
            } catch (error) {
                content.innerHTML = '<div style="padding: 20px; color: red;">Error loading email: ' + error.message + '</div>';
            }
        }

        function closeEmailDetail() {
            document.getElementById('detailPanel').classList.remove('open');
            document.getElementById('overlay').classList.remove('open');
        }

        // Close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeEmailDetail();
        });

        function loadFeed() {
            fetch('/api/feed?t=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    const feedDiv = document.getElementById('feed');
                    feedDiv.innerHTML = '';
                    
                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            const emailDiv = document.createElement('div');
                            emailDiv.className = 'email-item';
                            
                            let html = '';
                            html += '<div class="sender">@' + (item.sender_tag || 'unknown') + '</div>';
                            html += '<div class="timestamp">Â· ' + formatTimestamp(item.created_at) + '</div>';
                            html += '<div class="email-title">' + (item.title || 'No title') + '</div>';
                            
                            emailDiv.innerHTML = html;
                            
                            // Add Show More button
                            const showMoreBtn = document.createElement('button');
                            showMoreBtn.className = 'show-more-btn';
                            showMoreBtn.id = 'btn-' + item.id;
                            showMoreBtn.textContent = 'Show More â–¼';
                            const cardId = item.id; // Capture in closure
                            showMoreBtn.onclick = function() { toggleDetails(cardId); };
                            emailDiv.appendChild(showMoreBtn);
                            
                            // Create collapsible details div and append it immediately
                            const detailsDiv = document.createElement('div');
                            detailsDiv.className = 'card-details';
                            detailsDiv.id = 'details-' + item.id;
                            emailDiv.appendChild(detailsDiv); // APPEND IT NOW!
                            
                            // Combine actors and themes into keywords
                            let keywords = [];
                            if (item.actors) keywords.push(item.actors);
                            if (item.themes) keywords.push(item.themes);
                            
                            if (keywords.length > 0) {
                                const keywordsDiv = document.createElement('div');
                                keywordsDiv.className = 'keywords';
                                keywordsDiv.innerHTML = 'ðŸ”‘ Keywords: ' + keywords.join(' â€¢ ');
                                detailsDiv.appendChild(keywordsDiv);
                            }
                            
                            // Add summary
                            const summaryDiv = document.createElement('div');
                            summaryDiv.className = 'summary';
                            
                            let enrichedContent = item.enriched_content || 'No summary';
                            
                            // Check if has real article link
                            const hasRealLink = enrichedContent.includes('bloomberg.com') || 
                                              enrichedContent.includes('businessinsider.com') || 
                                              enrichedContent.includes('reuters.com') ||
                                              enrichedContent.includes('weekendreads.cmail') ||
                                              enrichedContent.includes('barrons.cmail') ||
                                              enrichedContent.includes('estadao.com.br') ||
                                              enrichedContent.includes('folha');
                            
                            // Replace Google News with email popup
                            if (!hasRealLink) {
                                enrichedContent = enrichedContent.replace(
                                    /ðŸ”— <a href="[^"]*google[^"]*"[^>]*>.*?<\/a>/gi,
                                    'ðŸ“§ <a href="#" onclick="openEmailDetail(\'' + item.id + '\'); return false;" style="color: #1DA1F2; text-decoration: none; font-weight: 600;">View original email</a>'
                                );
                                enrichedContent = enrichedContent.replace(
                                    /ðŸ”— <a href="[^"]*Buscar no Google[^"]*"[^>]*>.*?<\/a>/gi,
                                    'ðŸ“§ <a href="#" onclick="openEmailDetail(\'' + item.id + '\'); return false;" style="color: #1DA1F2; text-decoration: none; font-weight: 600;">Ver email original</a>'
                                );
                            }
                            
                            summaryDiv.innerHTML = enrichedContent;
                            detailsDiv.appendChild(summaryDiv);  // Changed to detailsDiv
                            
                            // Add footer
                            const footerDiv = document.createElement('div');
                            footerDiv.className = 'ai-score';
                            footerDiv.textContent = 'ðŸ¤– AI: ' + (item.ai_score || item.ai_relevance_score || 0) + '/10';
                            detailsDiv.appendChild(footerDiv);  // Changed to detailsDiv
                            
                            feedDiv.appendChild(emailDiv);
                        });
                        
                        console.log('Loaded ' + data.items.length + ' items with HTML popup');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Load feed
        loadFeed();
    </script>
</body>
</html>
